<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STREMA</title>
    <link rel="stylesheet" href="styles/recommendations.css">
    <link rel="stylesheet" href="styles/general.css">
    <link rel="icon" href="assets/logo.png" type="image/png">
    <script src="/eel.js"></script>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <h3 class="logo">STREMA</h3>
        <div class="nav-section">
            <p class="nav-item" onclick="navigateWithSlide('home.html', 'right')">Home</p>
            <p class="nav-item active" onclick="navigateWithSlide('recommendation.html', 'right')">Recommendations</p>
            <p class="nav-item" onclick="navigateWithSlide('history.html', 'left')">History</p>
            <p class="nav-item" onclick="navigateWithSlide('settings.html', 'left')">Settings</p>
        </div>
        <div class="username-container">
            <img class="user-icon" src="assets/user_icon.png" alt="User">
            <span class="username" id="displayUsername">Username</span>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="hero">
        <h1 class="hero-title">Recommendations</h1>
        <p class="hero-text">Take a moment to relax with a breathing exercise, a power nap, or some music.</p>
    </div>

    <!-- Features Section -->
    <div class="features-container">
        <div class="card breathing-section">
            <h2>Breathing Exercise</h2>
            <button id="startBreathingBtn" class="start-btn">Start</button>
            <div id="breathingContainer" class="breathing-container hidden">
                <div class="breathing-circle" id="breathingCircle"></div>
                <p id="breathingText" class="breathing-text">Get ready...</p>
                <p id="timerDisplay" class="timer-display">1:00</p>
                <button id="stopBreathingBtn" class="stop-btn">Stop</button>
            </div>
        </div>

        <div class="card powernap-section">
            <h2>Power Nap Timer</h2>
            <p>Choose a duration and relax while the timer tracks your rest.</p>
            <div class="nap-options">
                <button class="nap-btn" data-minutes="10">10 min</button>
                <button class="nap-btn" data-minutes="20">20 min</button>
                <button class="nap-btn" data-minutes="30">30 min</button>
                <button class="nap-btn" data-minutes="60">1 hr</button>
                <button class="nap-btn" data-minutes="120">2 hrs</button>
            </div>
            <div id="napTimerContainer" class="nap-timer hidden">
                <div id="napTimeDisplay" class="nap-time-display">00:00</div>
                <button id="stopNapBtn" class="stop-btn">Stop</button>
            </div>
        </div>
    </div>

    <!-- Music Section -->
    <div id="notificationBox" class="notification hidden"></div>
    <div class="music-section">
        <div class="music-column">
            <h2>My YouTube Tracks</h2>
            <input type="text" id="youtubeLinkInput" placeholder="Paste YouTube URL here">
            <button id="addYoutubeBtn">Add Track</button>
            <div id="uploadedList"></div>
            <div id="youtubePlayerContainer"></div>
            <div id="trackStatus"></div>
        </div>

        <div class="music-column">
            <h2>Playlists</h2>
            <input type="text" id="newPlaylistName" placeholder="Playlist name">
            <button id="createPlaylistBtn">Create Playlist</button>
            
            <div id="playlistContainer"></div>
        </div>
    </div>

    <!-- Quick Exercise Section -->
    <div class="exercise-section">
        <h2>Quick Exercises</h2>
        <div id="exerciseList" class="exercise-list">
            <!-- Buttons dynamically added -->
        </div>
        <div id="exercisePlayerContainer"></div>
    </div>

    <!-- Dance Exercise Section -->
    <div class="exercise-section"> <!-- use same class for unified style -->
        <h2>Dance Exercises</h2>
        <div id="danceExerciseList" class="exercise-list">
            <!-- Buttons dynamically added -->
        </div>
        <div id="danceExercisePlayerContainer"></div>
    </div>

    <script src="script.js"></script>

    <!-- Real-time Stress Display -->
    <div id="realtime-stress-box">
        <p id="realtime-stress-text">Detecting stress...</p>
    </div>

    <script>
    let detectionInterval = null;

    // Convert a video frame to dataURL (same as detection.html)
    async function captureFrame() {
        return new Promise(async (resolve) => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement("video");
                video.srcObject = stream;
                await video.play();

                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0);

                // Stop camera right after capturing
                stream.getTracks().forEach(t => t.stop());

                resolve(canvas.toDataURL("image/png"));
            } catch (err) {
                console.error("Frame capture error:", err);
                resolve(null);
            }
        });
    }

    async function runRealtimeStressDetection() {
        const frame = await captureFrame();
        if (!frame) {
            document.getElementById("realtime-stress-text").innerText = "No face detected";
            return;
        }

        eel.run_detection([frame], "both")(result => {
            if (!result) return;

            let level = "Unknown";

            if (result.combined !== undefined && result.combined !== null) {
                level = result.combined.toFixed(2);
            } else if (result.cnn_label !== null) {
                level = result.cnn_label;
            }

            document.getElementById("realtime-stress-text").innerText =
                "Real-time Stress: " + level;
        });
    }

    function startRealtimeStress() {
        if (!detectionInterval) {
            runRealtimeStressDetection(); // run immediately
            detectionInterval = setInterval(runRealtimeStressDetection, 10000); // every 10 seconds
        }
    }

    function stopRealtimeStress() {
        if (detectionInterval) {
            clearInterval(detectionInterval);
            detectionInterval = null;
        }
    }

    // Start when entering recommendation.html
    window.addEventListener("load", startRealtimeStress);

    // Stop when leaving
    window.addEventListener("beforeunload", stopRealtimeStress);
    </script>

</body>
</html>
